<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>EMI Auto-Payment System</title>
    <link rel="stylesheet" href="style.css" />
    <!-- Main app script (imports walletService, networkService automatically) -->
    <script type="module" src="./receiver.js" defer></script>
</head>

<body>

    <!-- ================= HEADER ================= -->
    <header class="header">
        <button class="back-btn" onclick="goBack()">‚Üê Back</button>
        <h1>Receiver Dashboard</h1>
        <p class="subtitle">Create EMI auto-payment plans</p>
    </header>

    <!-- ================= WALLET ================= -->
    <section class="card">
        <h2>Receiver Wallet</h2>

        <button id="connectWalletBtn">Connect Wallet</button>
        <button id="disconnectWalletBtn" style="display:none;">Disconnect</button>

        <p id="account" class="muted"></p>
        <p id="network" class="muted"></p>


    </section>

    <!-- ================= CREATE EMI ================= -->
    <section class="card">
        <h2>Create EMI Plan</h2>

        <!-- Blockchain -->
        <label>Blockchain</label>
        <select id="blockchainSelect"></select>


        <!-- EMI -->
        <!-- Update EMI/Total labels to show dynamic currency -->
        <label>EMI Amount (${NETWORK_CONFIG[currentChainId]?.currency || 'ETH'})</label>


        <input id="emiAmount" type="number" step="0.0001" placeholder="e.g. 0.01">

        <!-- Interval -->
        <label>Payment Interval</label>
        <select id="intervalSelect">
            <option value="3600">1 Hour</option>
            <option value="10800">3 Hours</option>
            <option value="21600">6 Hours</option>
            <option value="43200">12 Hours</option>
            <option value="86400">Daily</option>
            <option value="604800">Weekly</option>
            <option value="2592000">Monthly</option>
            <option value="custom">Custom (minutes)</option>
        </select>

        <input id="customInterval" type="number" placeholder="Minutes" style="display:none;" />

        <!-- Total -->
        <label>Total Amount (${NETWORK_CONFIG[currentChainId]?.currency || 'ETH'})</label>
        <input id="totalAmount" type="number" step="0.0001" placeholder="e.g. 0.1">

        <button id="createPlanBtn" class="primary-btn">
            Create EMI Plan
        </button>
    </section>

    <!-- ================= SHARE WITH SENDER ================= -->
    <!-- ================= SHARE WITH SENDER ================= -->
    <section class="card success" id="shareSection" style="display:none;">
        <h2>Share With Sender</h2>

        <label>MetaMask Deep Link (Mobile)</label>
        <div class="row">
            <input id="metamaskLinkOutput" type="text" readonly />
            <button onclick="copyText('metamaskLinkOutput')">üìã Copy</button>
        </div>
        <label>Trust Wallet App Link</label>
        <div class="row">
            <input id="trustwalletLinkOutput" type="text" readonly />
            <button onclick="copyText('trustwalletLinkOutput')">üìã Copy</button>
        </div>


        <label>Scan QR (Any Wallet)</label>
        <div class="qr-container">
            <div class="qr-box">
                <h4>ü¶ä Scan with MetaMask</h4>
                <canvas id="qrCanvasMetamask"></canvas>
                <button onclick="copyQR('qrCanvasMetamask')">üìã Copy QR</button>
            </div>

            <div class="qr-box">
                <h4>üü¢ Scan with Trust Wallet</h4>
                <canvas id="qrCanvasTrust"></canvas>
                <button onclick="copyQR('qrCanvasTrust')">üìã Copy QR</button>
            </div>
        </div>




    </section>

    <!-- ================= DIRECT PAYMENT SECTION ================= -->
    <section class="card success" id="directPaymentSection" style="display:none;">
        <h2>üí∏ Direct Payment Active</h2>
        <div id="directPaymentInstructions"></div>
    </section>

    <!-- ================= MONITORING STATUS ================= -->
    <section class="card" id="monitoringStatusSection" style="display:none;">
        <h2>üì° Live Monitoring Status</h2>
        <div style="background: #f3f4f6; padding: 16px; border-radius: 12px; border-left: 4px solid #3b82f6;">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 12px;">
                <div>
                    <p style="color: #6b7280; font-size: 12px; margin: 0;">PLAN STATUS</p>
                    <h3 id="statusBadge" style="margin: 4px 0; color: #ef4444;">‚è≥ WAITING</h3>
                </div>
                <div>
                    <p style="color: #6b7280; font-size: 12px; margin: 0;">SENDER</p>
                    <p id="senderAddress"
                        style="margin: 4px 0; font-family: monospace; font-size: 13px; word-break: break-all;">Not
                        detected yet</p>
                </div>
            </div>
            <div>
                <p style="color: #6b7280; font-size: 12px; margin: 0;">WHAT'S HAPPENING</p>
                <p id="statusMessage" style="margin: 4px 0; color: #374151; font-size: 14px;">
                    ‚è≥ Waiting for sender to transfer ETH to your wallet address...
                </p>
            </div>
        </div>
        <hr style="border: none; border-top: 1px solid #e5e7eb; margin: 16px 0;">
        <p style="color: #6b7280; font-size: 13px; margin: 0;">
            üí° <strong>What happens next:</strong> Once sender transfers ETH, the plan activates automatically.
            Chainlink Automation will then pull EMI amounts from sender every interval.
        </p>
    </section>

    <!-- ================= MODIFY RECEIVER ================= -->
    <section class="card warning">
        <h2>Modify Receiver Address</h2>

        <input id="modifyPlanId" type="number" placeholder="Plan ID" />
        <!-- <input id="newReceiverAddress" type="text" placeholder="New Receiver Address (0x...)" /> -->
        <input id="newReceiverAddress" type="text" placeholder="New Receiver Address (0x...)"
            pattern="^0x[a-fA-F0-9]{40}$" />
        <button id="modifyReceiverBtn" class="secondary-btn">
            Update Receiver
        </button>


    </section>

    <!-- ================= FOOTER ================= -->
    <footer class="footer">
        <p>
            üßæ Pull-based EMI system<br />
            üîí No funds held by this application
        </p>
    </footer>

    <script>
        function goBack() {
            window.location.href = "./home.html";
        }
    </script>

    <script>
        function copyText(id) {
            const el = document.getElementById(id);
            el.select();
            document.execCommand("copy");
        }
    </script>

    <script>
        async function copyQR(canvasId) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return alert("QR not found");

            canvas.toBlob(async (blob) => {
                try {
                    await navigator.clipboard.write([
                        new ClipboardItem({ "image/png": blob })
                    ]);
                    alert("‚úÖ QR copied to clipboard");
                } catch (err) {
                    console.error(err);
                    alert("‚ùå Clipboard copy not supported on this browser");
                }
            });
        }
    </script>



</body>

</html>